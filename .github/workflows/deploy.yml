name: Build and Deploy to GCP

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  build:
    runs-on: ubuntu-24.04
    environment: production
    outputs:
      short_sha: ${{ steps.sha.outputs.short_sha }}
      full_sha: ${{ steps.sha.outputs.full_sha }}
      container_image: ${{ steps.sha.outputs.container_image }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
      
    - name: Calculate SHA values
      id: sha
      run: |
        # Get the actual commit SHA from the current branch
        FULL_SHA=$(git rev-parse HEAD)
        SHORT_SHA=$(echo $FULL_SHA | cut -c1-8)
        CONTAINER_IMAGE="europe-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/owswims-repo/owswims"
        
        echo "full_sha=$FULL_SHA" >> $GITHUB_OUTPUT
        echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT  
        echo "container_image=$CONTAINER_IMAGE" >> $GITHUB_OUTPUT
        
        echo "## ðŸ”¨ Build Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Full SHA**: \`$FULL_SHA\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Short SHA**: \`$SHORT_SHA\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Container Image**: \`$CONTAINER_IMAGE\`" >> $GITHUB_STEP_SUMMARY
        
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCLOUD_SERVICE_KEY }}
        
    - name: Set up Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      
    - name: Configure Docker for Artifact Registry
      run: gcloud auth configure-docker europe-docker.pkg.dev
      
    - name: Build and push Docker image
      uses: docker/build-push-action@v6
      with:
        context: .
        push: true
        tags: |
          ${{ steps.sha.outputs.container_image }}:latest
          ${{ steps.sha.outputs.container_image }}:${{ steps.sha.outputs.short_sha }}
        build-args: |
          RELEASE_ID=${{ steps.sha.outputs.short_sha }}
          CI_COMMIT_REF_SLUG=${{ github.ref_name }}
          CI_COMMIT_SHA=${{ steps.sha.outputs.full_sha }}
          CI_BUILD_DATE=${{ github.event.head_commit.timestamp }}
          GOOGLE_MAPS_API_KEY=${{ secrets.GOOGLE_MAPS_API_KEY }}
          RAPIDAPI_KEY=${{ secrets.RAPIDAPI_KEY }}
          GRAPHQL_ENDPOINT=${{ vars.GRAPHQL_ENDPOINT }}
          DEFAULT_HEADER_IMAGE=${{ vars.DEFAULT_HEADER_PHOTO_URL }}
          SECRET_KEY=${{ secrets.SECRET_KEY }}
          SENTRY_DSN=${{ secrets.SENTRY_DSN }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Update build summary
      run: |
        echo "## âœ… Build Complete" >> $GITHUB_STEP_SUMMARY
        echo "- **Image Tags**:" >> $GITHUB_STEP_SUMMARY
        echo "  - \`${{ steps.sha.outputs.container_image }}:latest\`" >> $GITHUB_STEP_SUMMARY
        echo "  - \`${{ steps.sha.outputs.container_image }}:${{ steps.sha.outputs.short_sha }}\`" >> $GITHUB_STEP_SUMMARY

  deploy:
    needs: build
    runs-on: ubuntu-24.04
    environment: production
    if: github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCLOUD_SERVICE_KEY }}
        
    - name: Set up Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      
    - name: Install GKE gcloud auth plugin
      run: gcloud components install gke-gcloud-auth-plugin
      
    - name: Set GKE auth plugin environment
      run: echo "USE_GKE_GCLOUD_AUTH_PLUGIN=True" >> $GITHUB_ENV
        
    - name: Get GKE credentials
      run: |
        gcloud container clusters get-credentials ${{ secrets.K8S_CLUSTER }} \
          --region ${{ secrets.GCP_REGION }} \
          --project ${{ secrets.GCP_PROJECT_ID }}
          
    - name: Deploy to Kubernetes with Helm
      run: |
        echo "## ðŸš€ Deploying to Production" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: production" >> $GITHUB_STEP_SUMMARY
        echo "- **Namespace**: ${{ vars.KUBE_NAMESPACE }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Image Tag**: \`${{ needs.build.outputs.short_sha }}\`" >> $GITHUB_STEP_SUMMARY
        
        helm upgrade --install owswims -f helm/values.yaml helm/ \
          --namespace ${{ vars.KUBE_NAMESPACE }} \
          --create-namespace \
          --set-string image.tag="${{ needs.build.outputs.short_sha }}"
          
        echo "## âœ… Deployment Complete" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: Successfully deployed to GKE cluster" >> $GITHUB_STEP_SUMMARY
        echo "- **Image**: \`${{ needs.build.outputs.container_image }}:${{ needs.build.outputs.short_sha }}\`" >> $GITHUB_STEP_SUMMARY